#!/usr/bin/env node

/**
 * Contract Compilation Script
 * 
 * This script compiles Solidity contracts and generates TypeScript ABIs
 * that can be imported directly in the frontend.
 */

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const ARTIFACTS_DIR = path.join(__dirname, "..", "artifacts", "contracts");
const OUTPUT_DIR = path.join(__dirname, "..", "src", "lib", "ethers", "abis");

// Contracts to extract ABIs from (only the ones we actually use)
const CONTRACTS = [
  { name: "Voting", file: "Voting.sol" },
  { name: "GroupManager", file: "GroupManager.sol" },
];

function main() {
  console.log("ðŸ”¨ Compiling contracts with Hardhat...\n");

  try {
    // Run hardhat compile
    execSync("npx hardhat compile", {
      cwd: path.join(__dirname, ".."),
      stdio: "inherit",
    });
    console.log("\nâœ“ Contracts compiled successfully!\n");
  } catch (error) {
    console.error("âŒ Failed to compile contracts:", error.message);
    process.exit(1);
  }

  // Ensure output directory exists
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  console.log("ðŸ“¦ Extracting ABIs...\n");

  const abis = {};

  for (const contract of CONTRACTS) {
    const artifactPath = path.join(
      ARTIFACTS_DIR,
      contract.file,
      `${contract.name}.json`
    );

    if (!fs.existsSync(artifactPath)) {
      console.warn(`âš ï¸  Artifact not found for ${contract.name}: ${artifactPath}`);
      continue;
    }

    const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
    abis[contract.name] = artifact.abi;

    // Write individual ABI file
    const outputPath = path.join(OUTPUT_DIR, `${contract.name}.json`);
    fs.writeFileSync(outputPath, JSON.stringify(artifact.abi, null, 2));
    console.log(`  âœ“ ${contract.name}.json`);
  }

  // Generate TypeScript index file
  const indexContent = `/**
 * Auto-generated contract ABIs
 * 
 * Generated by: npm run compile
 * Do not edit manually!
 */

import VotingABI from "./Voting.json";
import GroupManagerABI from "./GroupManager.json";

export const abis = {
  Voting: VotingABI,
  GroupManager: GroupManagerABI,
} as const;

export { VotingABI, GroupManagerABI };
`;

  fs.writeFileSync(path.join(OUTPUT_DIR, "index.ts"), indexContent);
  console.log(`  âœ“ index.ts`);

  // Generate bytecode file for deployment
  const bytecodesContent = `/**
 * Auto-generated contract bytecodes
 * 
 * Generated by: npm run compile
 * Do not edit manually!
 */

${CONTRACTS.map((contract) => {
  const artifactPath = path.join(
    ARTIFACTS_DIR,
    contract.file,
    `${contract.name}.json`
  );
  if (fs.existsSync(artifactPath)) {
    const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));
    return `export const ${contract.name}Bytecode = "${artifact.bytecode}";`;
  }
  return `export const ${contract.name}Bytecode = "";`;
}).join("\n\n")}
`;

  fs.writeFileSync(path.join(OUTPUT_DIR, "bytecodes.ts"), bytecodesContent);
  console.log(`  âœ“ bytecodes.ts`);

  console.log("\nâœ… All ABIs extracted successfully!");
  console.log(`   Output directory: ${OUTPUT_DIR}`);
}

main();
